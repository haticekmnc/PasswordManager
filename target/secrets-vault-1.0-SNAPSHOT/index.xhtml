<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Password Manager</title>
        <h:outputStylesheet name="css/index_style.css"/>
        <h:outputStylesheet name="css/add_password_style.css"/>
    </h:head>
    <h:body>
        <!-- Navbar -->
        <div class="navbar">
            <div>
                <a href="#" class="password-list">Password List</a>
            </div>
            <div>
                <a href="logPage.xhtml" class="logout">Log Page</a>
            </div> 
            <h:form>
                <div>
                    <h:commandButton value="Logout" action="#{loginMB.logout}" class="logout" />
                </div>
            </h:form>
        </div>
        <!-- DataTable Container -->
        <h:form id="passwordForm" class="table-container">
            <!-- Add Password Button -->
            <div class="add-password-button-container">
                <p:button value="Add Password" outcome="addPassword.xhtml" styleClass="add-password-button" icon="pi pi-plus"/>
            </div>
            <!-- Search and Filter Controls -->
            <div class="table-container">
                <p:dataTable id="dataTable" var="password" value="#{passwordBean.passwords}" styleClass="custom-datatable" widgetVar="passwordTableVar"
                             rows="10" paginator="true" paginatorPosition="bottom" paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} 
                             {PageLinks} {NextpageLink} {LastPageLink} {RowsPerPageDropdown}"
                             currentPageReportTemplate="{startRecord}--{endRecord} of {totalRecords} records"
                             rowsPerPageTemplate="5,10,{ShowAll|'All'}">
                    <p:column headerText="System Information" filterBy="#{password.systemInformation}" filterMatchMode="contains">
                        <h:outputText value="#{password.systemInformation}" />
                    </p:column>
                    <p:column headerText="Access Information" filterBy="#{password.accessInformation}" filterMatchMode="contains">
                        <h:outputText value="#{password.accessInformation}"/>
                    </p:column>
                    <p:column headerText="Username" filterBy="#{password.username}" filterMatchMode="contains">
                        <h:outputText value="#{password.username}"/>
                    </p:column>
                    <p:column headerText="Password">
                        <h:outputText value="********" styleClass="password-hidden" rendered="#{!password.showPassword}" />
                        <h:outputText value="#{password.decryptedPassword}" styleClass="password-visible" rendered="#{password.showPassword}" />
                        <p:commandLink title="Verify to Show/Hide Password" 
                                       actionListener="#{passwordBean.prepareForVerification(password)}"
                                       oncomplete="PF('loginDialog').show();" update=":loginDialogForm">
                            <i class="#{password.showPassword ? 'pi pi-eye' : 'pi pi-eye-slash'}" />
                        </p:commandLink>
                    </p:column>
                    <p:column headerText="Notes" filterBy="#{password.notes}" filterMatchMode="contains" styleClass="notes-cell">
                        <h:outputText value="#{password.notes}"/>
                    </p:column>
                    <p:column headerText="Actions">
                        <p:commandButton value="Edit" icon="pi pi-pencil" styleClass="btn-edit"
                                         actionListener="#{passwordMB.prepareUpdate(password)}"
                                         update=":editDialogForm" oncomplete="PF('editDialog').show();" />
                        <p:commandButton value="Delete" icon="pi pi-trash" styleClass="btn-delete"
                                         actionListener="#{passwordMB.deletePassword(password)}"
                                         onclick="PF('confirmation').show(); return false;"
                                         update="dataTable" />
                        <p:confirmDialog global="true" widgetVar="confirmation" header="Silme Onayı" message="Bu şifreyi silmek istediğinize emin misiniz?" severity="alert" styleClass="add-password-form">
                            <p:commandButton value="Evet" styleClass="ui-confirmdialog-yes" style="color:green;" icon="pi pi-check" actionListener="#{passwordMB.deletePassword(password)}" update="dataTable"/>
                            <p:commandButton value="Hayır" styleClass="ui-confirmdialog-no" style="color:red;" icon="pi pi-times" onclick="PF('confirmation').hide(); return false;"/>
                        </p:confirmDialog>
                    </p:column>

                </p:dataTable>
            </div>
        </h:form>

        <!-- Login Dialog -->
        <!-- Login Dialog -->
        <p:dialog header="Login Verification" widgetVar="loginDialog" modal="true" resizable="false" style="color:black;" >
            <h:form id="loginDialogForm" styleClass="add-password-form">
                <div class="container">
                    <h:panelGrid columns="3">
                        <h:outputLabel for="verifyUsername" value="Username:" />
                        <p:inputText id="verifyUsername" value="#{passwordBean.verifyUsername}" required="true"/>
                        <p:message for="verifyUsername"/>

                        <h:outputLabel for="verifyPassword" value="Password:" />
                        <p:password id="verifyPassword" value="#{passwordBean.verifyPassword}" required="true"/>
                        <p:message for="verifyPassword"/>
                        <p:growl id="verifyMessage" life="3000"/>
                        <p:commandButton value="Verify" styleClass="save-button" 
                                         actionListener="#{passwordBean.verifyAndToggleShowPassword}"
                                         update="verifyMessage"  onclick="showEffectsDialog();" oncomplete="PF('loginDialog').hide();"/>

                    </h:panelGrid>
                </div>

                <!-- geri git tuşu -->
                <h:button value="&#8592;" style="font-size: 20px;" outcome="index.xhtml" styleClass="back-button"/>
            </h:form>
        </p:dialog>
        <!-- Edit Dialog -->
        <p:dialog  widgetVar="editDialog" 
                   modal="true" appendTo="@(body)" styleClass="ui-widget-overlay" resizable="false"
                   height="auto" width="auto"  >
            <h:form id="editDialogForm" styleClass="add-password-form">
                <div class="container">
                    <div class="add-password-form">
                        <h2>Edit Password</h2>

                        <div class="form-field-group">
                            <div class="form-field">
                                <label for="title">Sistem Bilgileri:</label>
                                <h:inputText id="title" value="#{passwordMB.selectedPassword.systemInformation}" required="true" requiredMessage="System Information is required." />
                                <h:message for="title" style="color: red" />

                            </div>
                            <div class="form-field">
                                <label for="url">Erişim Bilgileri:</label>
                                <h:inputText id="url" value="#{passwordMB.selectedPassword.accessInformation}" />
                            </div>
                        </div>

                        <div class="form-field-group">
                            <div class="form-field">
                                <label for="username">Username:</label>
                                <h:inputText id="username" value="#{passwordMB.selectedPassword.username}" required="true" />
                                <h:message for="username" style="color: red" />
                            </div>
                            <div class="form-field">
                                <label for="password">Password:</label>
                                <h:inputSecret id="password" value="#{passwordMB.selectedPassword.password}" required="true" />
                                <h:message for="password" style="color: red" />
                            </div>
                        </div>

                        <div class="form-field notes">
                            <label for="notes">Notes:</label>
                            <h:inputTextarea id="notes" value="#{passwordMB.selectedPassword.notes}" styleClass="auto-expand" />
                        </div>
                        <div class="form-field">
                            <p:commandButton value="Save" actionListener="#{passwordMB.updatePassword(passwordMB.selectedPassword)}" 
                                             update=":passwordForm:dataTable" oncomplete="PF('editDialog').hide();" 
                                             styleClass="save-button" />
                        </div>
                    </div>
                </div>
            </h:form>
            <!-- geri git tuşu -->
            <div class="form-field" style="position: absolute; top: 20px; left: 20px;">
                <h:button value="&#8592;" style="font-size: 20px;" outcome="index.xhtml" styleClass="back-button">
                </h:button>
            </div>

        </p:dialog>
        <h:form>
            <p:confirmDialog widgetVar="sessionTimeoutDialog" header="Oturum Zaman Aşımı Uyarısı"
                             message="Oturumunuz 1 dakika içinde sona erecek. Oturumu yenilemek ister misiniz?" severity="warn">
                <p:commandButton value="Evet" oncomplete="resetTimer()" />
                <p:commandButton value="Hayır" onclick="PF('sessionTimeoutDialog').hide(); window.location.href = 'logout.xhtml';" />
            </p:confirmDialog>
        </h:form>


        <!-- Logout için form (Gizli bir form olarak yerleştirilebilir) -->
        <h:form id="logoutForm" style="display:none">
            <h:commandButton id="logoutButton" action="#{loginMB.logout}" style="display:none" />
        </h:form>

        <script>
            // Parola gösterme/gizleme ve şifre işlevlerini yöneten fonksiyonlar
            function togglePasswordVisibility(passwordId) {
                var passwordElement = document.getElementById('password_' + passwordId);
                var isPasswordVisible = passwordElement.classList.contains('visible-password');
                console.log("Parola kimliği için görünürlüğü değiştirme:", passwordId);

                if (isPasswordVisible) {
                    console.log("Şifre şu anda görünür durumda. GİZLE.");
                    passwordElement.classList.remove('visible-password');
                    passwordElement.textContent = '********';
                } else {
                    console.log("Şifre şu anda gizli. GÖSTER!.");
                    passwordElement.classList.add('visible-password');
                    passwordElement.textContent = passwordElement.dataset.password;
                    hidePasswordAutomatically(3);
                }
            }

            function hidePasswordAutomatically(timeout) {
                console.log("Otomatik şifre gizleme zamanlaması", timeout, "seconds.");
                setTimeout(() => {
                    var passwordFields = document.querySelectorAll('.password-visible');
                    passwordFields.forEach(field => {
                        field.textContent = '********';
                        field.classList.remove('password-visible');
                        field.classList.add('password-hidden');
                    });
                    document.querySelectorAll('.pi-eye').forEach(icon => {
                        icon.classList.remove('pi-eye');
                        icon.classList.add('pi-eye-slash');
                    });
                }, timeout * 1000);
            }

            // Oturum zaman aşımı uyarıları ve yönlendirmeler
            var timeoutWarning = 900000; // 15 dakika sonra uyarı
            var timeoutLogout = 960000;  // 16 dakika sonra logout

            function handleSessionTimeout() {
                setTimeout(() => {
                    alert('Oturumunuz 1 dakika içinde sona erecek. Oturumu yenilemek için herhangi bir sayfayı yenileyin.');
                }, timeoutWarning);

                setTimeout(() => {
                    window.location.href = "login.xhtml"; // Oturum sonlandırma ve logout sayfasına yönlendirme
                }, timeoutLogout);
            }

            // Kullanıcı etkinliğini izleyerek oturum zamanlayıcılarını sıfırlama
            function resetTimer() {
                clearTimeout(timeoutWarning);
                clearTimeout(timeoutLogout);
                handleSessionTimeout(); // Zamanlayıcıları yeniden başlat
            }

            window.onload = resetTimer;
            document.onmousemove = resetTimer;
            document.onmousedown = resetTimer;
            document.ontouchstart = resetTimer;
            document.onclick = resetTimer;
            document.onkeypress = resetTimer;
            window.addEventListener('scroll', resetTimer, true);

            // Oturum zaman aşımı logunu server'a gönderme
            function logSessionTimeout() {
                fetch('LogSessionTimeout', {
                    method: 'POST'
                })
                        .then(response => {
                            if (response.ok) {
                                console.log("Session timeout logged successfully");
                            }
                        })
                        .catch(error => console.error('Error logging session timeout:', error));
            }
            
            window.onload = function() {
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
};


            // Auto-expand textareas as they are typed in
            document.querySelectorAll('.auto-expand').forEach(field => {
                field.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                autoExpandField(field); // Başlangıçta da boyutlandır
            });
        </script>

    </h:body>
</html>